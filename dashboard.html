<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BlockCert</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <nav class="navbar"></nav>

        <section class="hero" style="padding: 60px 0; text-align: left;">
            <h1 id="welcomeMsg" style="font-size: 3.5rem; margin-bottom: 10px;">Welcome Back</h1>
            <p id="userNameSub" style="font-size: 1.2rem; color: var(--text-sec); font-weight: 600;"></p>
        </section>

        <!-- Dynamic Content Sections -->
        <div id="institutionTools" style="display: none;">
            <h2>Institution Implementation</h2>
            <div class="features"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="card">
                    <h3>Issue New Certificate</h3>
                    <p>Create and hash a new academic certificate on the blockchain.</p>
                    <a href="issue.html" class="btn btn-primary" style="margin-top: 10px;">Go to Issue</a>
                </div>
                <div class="card">
                    <h3>Manage Records</h3>
                    <p>View issued certificates and revocation status.</p>
                    <button class="btn btn-outline" style="margin-top: 10px;" disabled>Coming Soon</button>
                </div>
            </div>
        </div>

        <div id="studentTools" style="display: none;">
            <h2>Student Wallet</h2>
            <p style="margin-bottom: 20px;">Your secured certificates stored on the blockchain.</p>
            <div id="walletList"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Wallet Items Loaded Here -->
                <div id="walletLoader" class="card" style="text-align: center; padding: 40px;">
                    <p>Loading your secure wallet...</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 40px;">
            <h2>Global Tools</h2>
            <div class="card" style="margin-top: 10px;">
                <h3>Verify a Certificate</h3>
                <p>Check the validity of any certificate ID.</p>
                <a href="verify.html" class="btn btn-primary" style="margin-top: 10px;">Verification Portal</a>
            </div>

            <!-- Chatbot Widget Trigger -->
            <div style="position: fixed; bottom: 30px; right: 30px;">
                <a href="chatbot.html" class="btn btn-primary"
                    style="border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">ðŸ’¬</a>
            </div>
        </div>
    </div>

    <script src="js/themeToggle.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check Auth
        requireAuth();

        // Setup UI based on Role
        const role = localStorage.getItem('user_role');
        const name = localStorage.getItem('user_name');

        document.getElementById('userNameSub').textContent = `Logged in as ${name}`;
        document.getElementById('welcomeMsg').textContent = `Overview`;

        if (role === 'institution') {
            document.getElementById('institutionTools').style.display = 'block';
        } else if (role === 'student') {
            document.getElementById('studentTools').style.display = 'block';
            loadWallet();
        }

        async function loadWallet() {
            const email = localStorage.getItem('user_email');
            const list = document.getElementById('walletList');

            try {
                const response = await fetch(`http://localhost:8000/certificate/wallet/${email}`);
                const data = await response.json();

                list.innerHTML = "";

                if (data.wallet.length === 0) {
                    list.innerHTML = `
                        <div class="card" style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <h3>Your wallet is empty</h3>
                            <p>Certificates issued to your email will appear here automatically.</p>
                        </div>
                    `;
                    return;
                }

                data.wallet.forEach(cert => {
                    const card = document.createElement('div');
                    card.className = "cert-card";
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h3 style="margin-bottom: 5px;">${cert.data.course}</h3>
                                <p style="font-size: 0.9rem; color: var(--text-sec);">${cert.data.issuer}</p>
                            </div>
                            <span class="badge" style="background: var(--success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">Verified</span>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.8rem; font-family: monospace; color: var(--text-sec);">
                            ID: ${cert.id}
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <a href="verify.html?id=${cert.id}" class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 0.9rem;">View & Verify</a>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (err) {
                list.innerHTML = `<p style="color: var(--error)">Error loading wallet: ${err.message}</p>`;
            }
        }
    </script>
</body>

</html>